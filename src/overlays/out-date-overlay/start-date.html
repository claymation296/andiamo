<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../../../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/slide-down-animation.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/slide-from-top-animation.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/slide-from-bottom-animation.html">
<link rel="import" href="../../../bower_components/neon-animation/animations/transform-animation.html">

<link rel="import" href="../../../bower_components/neon-animation/animations/cascaded-animation.html">



<link rel="import" href="../../shared-styles.html">
<link rel="import" href="../../../behaviors/on-tap-behavior.html">



<dom-module id="start-date">
  <template>
    <style include="shared-styles">

      :host {
        opacity: 0;
      	background-color: var(--primary-background-color);
      }

      app-toolbar {
        color: var(--light-text-color);
        background-color: var(--dark-primary-color);
      }

      paper-fab {
        --paper-fab: {
          display: none;
          position: fixed;
          right: 16px;
          bottom: 16px;
        };
        --paper-fab-iron-icon: {
          color: var(--dark-text-color);
        };
        --paper-fab-keyboard-focus-background: var(--accent-color);
      }

      .hiddenBeforeAnimation {
        opacity: 0;
      }

    </style>

    <app-header-layout has-scrolling-region>

          <!--BEN: need to mess with to get pink header-->
        <app-header condenses reveals>
          <app-toolbar>
            <paper-icon-button id="backButton"
                               class="hiddenBeforeAnimation"
                               icon="my-icons:arrow-back"
                               on-tap="_backButtonTapped">
            </paper-icon-button>
            <div id="title" 
                 class="hiddenBeforeAnimation" 
                 main-title>Start Date
            </div>
          </app-toolbar>
        </app-header>

        <paper-date-picker id="picker" 
                           date="{{date}}" 
                           min-date="[[minDate]]">
        </paper-date-picker>
        
      </app-header-layout>
    </app-drawer-layout>

    <paper-fab id="fab" 
               on-tap="_fabTapped" 
               icon="my-icons:arrow-forward">
    </paper-fab>

    

  </template>

  <script>
    Polymer({
      is: 'start-date',

      behaviors: [
        Polymer.NeonAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior,
        window.BCDEV.Behaviors.OnTapBehavior 
      ],

      properties: {

      	animationConfig: {
      		value() {
      			return {
              'startEntry': [{
                name: 'slide-from-top-animation',
                node: this,
                timing: {duration: 300, easing: 'ease-out'}
              }, {
                name: 'fade-in-animation',
                node: this,
                timing: {duration: 200, delay: 100, easing: 'ease-in'}
              }],
              'startCascade': [{
                name: 'cascaded-animation',
                animation: 'slide-from-top-animation',
                // nodes set imperitively in init()
                timing: {duration: 100, delay: 50, easing: 'ease-out'}
              }, {
                name: 'cascaded-animation',
                animation: 'fade-in-animation',
                // nodes set imperitively in init()
                timing: {duration: 75, delay: 75, easing: 'ease-out'}
              }, {
                name: 'slide-from-bottom-animation',
                // node set imperitiveley -> this.monthsEl
                timing: {duration: 500, easing: 'ease-out'}
              }, {
                name: 'fade-in-animation',
                // node set imperitiveley -> this.monthsEl
                timing: {duration: 200, delay: 300, easing: 'ease-in'}
              }, {
                name: 'slide-from-right-animation',
                // node set imperitiveley -> this.leftChevronEl
                timing: {duration: 800, easing: 'ease-out'}
              }, {
                name: 'slide-from-left-animation',
                // node set imperitiveley -> this.rightChevronEl
                timing: {duration: 800, easing: 'ease-out'}
              }, {
                name: 'fade-in-animation',
                // node set imperitiveley -> this.leftChevronEl
                timing: {duration: 200, delay: 500, easing: 'ease-in'}
              }, {
                name: 'fade-in-animation',
                // node set imperitiveley -> this.rightChevronEl
                timing: {duration: 200, delay: 500, easing: 'ease-in'}
              }],
              'exit': [{
                name: 'slide-left-animation',
                node: this,
                timing: {duration: 200, easing: 'ease-in'}
              },{
                name: 'fade-out-animation',
                node: this,
                timing: {duration: 100, delay: 100, easing: 'ease-in'}
              }],
              'fabEntry': [{
                name: 'transform-animation',
                node: this.$.fab,
                transformFrom: 'scale(0, 0)',
                transformTo: 'scale(1, 1)',
                timing: {duration: 200, easing: 'ease-out'}
              }, {
                name: 'fade-in-animation',
                node: this.$.fab,
                timing: {duration: 100, delay: 100, easing: 'ease-out'}
      				}],
              'fabExit': [{
                name: 'slide-down-animation',
                node: this.$.fab,
                timing: {duration: 200, easing: 'ease-in'}
              }, {
                name: 'fade-out-animation',
                node: this.$.fab,
                timing: {duration: 100, delay: 100, easing: 'ease-in'}
              }],
      			};
      		}
      	},

        date: {
          type: Date,
          observer: '_dateChanged'
        },

        minDate: {
          type: Date,
          value: () => new Date
        },

        yearEl: Object,

        dayOfTheWeekEl: Object,

        dateEl: Object,        

        monthsEl: Object,

        leftChevronEl: Object, 
      
        rightChevronEl: Object
      },


      listeners: {
        'neon-animation-finish': '_animationComplete'
      },


      attached() {
        this.async(() => {
          const datePickerDom = Polymer.dom(this.$.picker).node.$;
          const heading       = datePickerDom.heading;
          const calendar      = datePickerDom.calendar.$.calendar;
          const monthNav      = calendar.children.monthNav;
          // animation nodes
          this.yearEl         = heading.children[0];
          this.dayOfTheWeekEl = heading.children[1].children[0];
          this.dateEl         = heading.children[1].children[1];
          this.monthsEl       = calendar.children.months.firstElementChild;
          this.leftChevronEl  = monthNav.firstElementChild;
          this.rightChevronEl = monthNav.lastElementChild;

          this.yearEl.style.opacity          = '0';
          this.dayOfTheWeekEl.style.opacity  = '0';
          this.dateEl.style.opacity          = '0';
          this.monthsEl.style.opacity        = '0';
          this.leftChevronEl.style.opacity   = '0';
          this.rightChevronEl.style.opacity  = '0';
          // can't transform a span without a display explicitly set
          this.dayOfTheWeekEl.style.display  = 'inline-block';
          this.dateEl.style.display          = 'inline-block';



          const monthRows     = this.monthsEl.children;
          // animation nodes
          const monthName     = monthRows[0].firstElementChild;
          
          // const monthDays = rows => {
          //   const length = rows.length;

          //   const allDays = (days, index) => {
          //     if (index === length) { return days; }
              
          //     const newDays = [...days, ...rows[index].children];
          //     return allDays(newDays, index + 1);
          //   };

          //   return allDays([], 1);
          // };
          // // animation nodes
          // const remainingRows = monthDays([...monthRows]);
          // all animation nodes
          const cascaders = [
            this.$.backButton,
            this.$.title,
            this.yearEl,        
            this.dayOfTheWeekEl,
            this.dateEl,
            // leftChevron,
            // monthName,
            // rightChevron,
            // ...remainingRows
          ];

          this.animationConfig.startCascade[0].nodes = cascaders;
          this.animationConfig.startCascade[1].nodes = cascaders;
          this.animationConfig.startCascade[2].node  = this.monthsEl;
          this.animationConfig.startCascade[3].node  = this.monthsEl;
          this.animationConfig.startCascade[4].node  = this.leftChevronEl;
          this.animationConfig.startCascade[5].node  = this.rightChevronEl;
          this.animationConfig.startCascade[6].node  = this.leftChevronEl;
          this.animationConfig.startCascade[7].node  = this.rightChevronEl;
        });
      },

      _animationComplete(_, animationType) {
        if (animationType === 'startEntry') {
          Polymer.dom(this.$.backButton).classList.remove('hiddenBeforeAnimation');
          Polymer.dom(this.$.title).classList.remove('hiddenBeforeAnimation');
          this.yearEl.style.opacity          = '1';
          this.dayOfTheWeekEl.style.opacity  = '1';
          this.dateEl.style.opacity          = '1';
          this.monthsEl.style.opacity        = '1';
          this.leftChevronEl.style.opacity   = '1';
          this.rightChevronEl.style.opacity  = '1';

          this.cancelAnimation();
          this.playAnimation('startCascade', 'startCascade');
        } else if (animationType === 'startCascade') {
          console.log('start entry done');
        }
      }, 

      // called by out-of-office.html as a callback to open()
      init() {
        // corrects a styling bug in paper-date-picker when
        // setting from display: none;
        this.$.picker.set('hidden', false);
        this.$.picker.fire('iron-resize');
        
        const play = () => {
          this.style.opacity = '1';
          this.cancelAnimation();
          this.playAnimation('startEntry', 'startEntry');
        };

        this.schedule(play);
      },

      
      _dateChanged(_, oldDate) {
        if (oldDate) {
          this.$.fab.style.display = 'flex';
          this.cancelAnimation();
          this.playAnimation('fabEntry', 'fabEntry');
        }
      },


      _backButtonTapped() {
      	const back = () => {
      		this.fire('start-date-back-button-tapped');
      	};

      	this.onTap = back;
      },


      _fabTapped() {
        const next = () => {
          this.fire('start-date-fab-tapped', {date: this.date});
        };

        this.onTap = next;
      }

    });
  </script>
</dom-module>
